-- Migration: Add support for Rubrics and AI Feedback
-- Date: 2025-11-21

-- 1. Add new columns to evaluations table
ALTER TABLE public.evaluations 
ADD COLUMN IF NOT EXISTS ai_feedback TEXT,
ADD COLUMN IF NOT EXISTS checkpoint VARCHAR(50); -- e.g., 'week_4', 'week_8', 'final'

-- 2. Add comment to explain the new columns
COMMENT ON COLUMN public.evaluations.ai_feedback IS 'Feedback generated by AI based on criteria scores';
COMMENT ON COLUMN public.evaluations.checkpoint IS 'Progressive evaluation checkpoint (e.g., week_4, week_8)';

-- 3. Update evaluation_templates to ensure criteria JSONB supports rubrics
-- This is a soft check, as JSONB is flexible, but good to document the expected structure
-- Expected structure for criteria element:
-- {
--   "id": "market_size",
--   "name": "Tamanho de Mercado",
--   "weight": 2,
--   "max_score": 10,
--   "rubric": {
--     "0": "Não sabe estimar",
--     "5": "Estimativa básica sem fontes",
--     "10": "TAM/SAM/SOM claros com fontes confiáveis"
--   }
-- }

-- 4. Create a function to auto-generate a sample template with rubrics (Optional helper)
CREATE OR REPLACE FUNCTION public.create_sample_rubric_template()
RETURNS UUID AS $$
DECLARE
  new_template_id UUID;
BEGIN
  INSERT INTO public.evaluation_templates (
    name,
    description,
    total_weight,
    criteria,
    is_active
  ) VALUES (
    'Avaliação Progressiva (Com Rubricas)',
    'Template avançado com descrições detalhadas para cada nível de pontuação.',
    10,
    '[
      {
        "id": "problem_validation",
        "name": "Validação do Problema",
        "weight": 3,
        "max_score": 10,
        "description": "Clareza e validação da dor do cliente",
        "rubric": {
          "0": "Problema não claro ou irrelevante",
          "5": "Problema entendido mas sem validação com clientes",
          "10": "Problema validado com >10 entrevistas e dados quantitativos"
        }
      },
      {
        "id": "solution_fit",
        "name": "Solução & Proposta de Valor",
        "weight": 3,
        "max_score": 10,
        "description": "Adequação da solução ao problema identificado",
        "rubric": {
          "0": "Solução genérica sem diferencial",
          "5": "Solução resolve o problema mas sem barreira de entrada",
          "10": "Solução única, 10x melhor que alternativas, com "unfair advantage""
        }
      },
      {
        "id": "market_potential",
        "name": "Potencial de Mercado",
        "weight": 2,
        "max_score": 10,
        "description": "Tamanho e crescimento do mercado alvo",
        "rubric": {
          "0": "Mercado pequeno ou em declínio",
          "5": "Mercado interessante mas nichado",
          "10": "Mercado bilionário em crescimento acelerado (CAGR > 10%)"
        }
      },
      {
        "id": "team_capability",
        "name": "Capacidade do Time",
        "weight": 2,
        "max_score": 10,
        "description": "Capacidade de execução e complementariedade",
        "rubric": {
          "0": "Time incompleto ou sem experiência",
          "5": "Time técnico forte mas sem visão de negócios (ou vice-versa)",
          "10": "Time completo, experiente e com histórico de execução"
        }
      }
    ]'::jsonb,
    true
  ) RETURNING id INTO new_template_id;
  
  RETURN new_template_id;
END;
$$ LANGUAGE plpgsql;
